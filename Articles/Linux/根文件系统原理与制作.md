# 根文件系统原理与制作

标签（空格分隔）： 嵌入式linux  根文件系统

---

## 1. 根文件系统原理

### 1.1 为什么需要根文件系统

- init进程的应用程序在根文件系统上
- 根文件系统提供了根目录 /
- 内核启动后的应用层配置( etc 目录)在根文件系统上。几乎可以认为：发行版=内核+rootfs
- shell命令程序在根文件系统上，比如 ls、cd 等命令

一套linux体系，只有内核本身是不能工作的，必须要 rootfs 上的 etc 目录下的配置文件、/bin  /sbin 等目录下的 shell 命令，还有 /lib 目录下的库文件等···）相配合才能工作 。

### 1.2 根文件系统的实质

- 根文件系统是特殊用途的文件系统。
- 根文件系统也必须属于某种文件系统格式。rootfstype=

存储设备（块设备，像硬盘、flash等）是分块（扇区）的，物理上底层去访问存储设备时是按照块号（扇区号）来访问的。

文件系统是一些代码，是一套软件，这套软件的功能就是对存储设备的扇区进行管理，将这些扇区的访问变成了对目录和文件名的访问。我们在上层按照特定的目录和文件名去访问一个文件时，文件系统会将这个目录+文件名转换成对扇区号的访问。不同的文件系统的差异就在于对这些扇区的管理策略和方法不同，譬如坏块管理、碎片管理。

### 1.2 根文件系统的形式

- 使用专用工具软件制作的可供烧录的镜像文件
- 镜像中包含了根文件系统中的所有文件
- 烧录此镜像类似于对相应分区格式化。
- 镜像文件系统具有一定的格式，格式是内化的，跟文件名后缀是无关的。

以文件夹形式构成的文件系统：

- 根文件系统其实就是一个包含特定内容的文件夹
- 根文件系统可由任何一个空文件夹添加必要文件构成而成
- 根文件系统的雏形就是在开发主机中构造的文件夹形式的

镜像文件形式的根文件系统主要目的是用来烧录到块设备上，设备上的内核启动后去挂载它。镜像文件形式的根文件系统是由文件夹形式的根文件系统使用专用的镜像制作工具制作而成的。

最初在开发主机中随便 mkdir 创建了一个空文件夹，然后向其中添加一些必要的文件（包括etc目录下的运行时配置文件、/bin 等目录下的可执行程序、/lib目录下的库文件等···）后就形成了一个文件夹形式的 rootfs。然后这个文件夹形式的 rootfs 可以被 kernel 通过 nfs 方式来远程挂载使用，但是不能用来烧录块设备。我们为了将这个 rootfs 烧录到块设备中于是用一些专用的软件工具将其制作成可供烧录的一定格式的根文件系统镜像。

文件夹形式的 rootfs 是没有格式的，制作成镜像后就有了一定的 rootfs 格式了，格式是由我们的镜像制作过程和制作工具来决定的。每一种格式的镜像制作工具的用法都不同。

### 1.3  自己制作简单的根文件系统
#### 1.3.1 动手制作ext3格式的根文件系统

- mke2fs介绍

mke2fs 是一个应用程序，在 ubuntu 中默认是安装了的。这个应用程序就是用来制作 ext2、ext3、ext4 等格式的根文件系统的。一般用来制作各种不同格式的 rootfs 的应用程序的名字都很相似，类似于 mkfs.xxx（譬如用来制作 ext2 格式的 rootfs 的工具叫 mkfs.ext2、用来制作 jffs2 格式的 rootfs 的工具就叫 mkfs.jffs2）。ubuntu14.04中的 mkfs.ext2 等都是 mke2fs 的符号链接而已。

1. 创建rootfs.ext2文件并且将之挂载到一个目录下方便访问它
《参考资料：http://blog.csdn.net/zhengmeifu/article/details/24174513》

```
dd if=/dev/zero of=rootfs.ext2 bs=1024 count=2048
losetup  /dev/loop1 rootfs.ext2
mke2fs -m 0 /dev/loop1 2048
mount -t ext2 /dev/loop1 ./rootfs/
```

2. 我们向镜像中写入一个普通文件linuxrc。这个文件就会成为我们制作的镜像中的/linuxrc。内核挂载了这个镜像后就会尝试去执行/linuxrc。然后执行时必然会失败。我们将来实验看到的现象就应该是：挂载成功，执行/linuxrc失败。

3. 将来真正去做有用的rootfs时，就要在这一步添加真正可以执行的linuxrc程序，然后还要添加别的/lib目录下的库文件，/etc目录下的配置文件等。

4. 卸载掉，然后镜像就做好了。
```
umount /dev/loop1
losetup -d /dev/loop1
```

#### 1.3.2 nfs 方式启动 rootfs
- 什么是 nfs?

nfs 是一种网络通讯协议，由服务器和客户端构成。利用 nfs 协议可以做出很多直接性应用，我们这里使用 nfs 主要是做 rootfs 挂载。开发板中运行 kernel 做 nfs 客户端，主机 ubuntu 中搭建 nfs 服务器。在主机 ubuntu 的 nfs 服务器中导出我们制作的文件夹形式的 rootfs 目录，则在客户端中就可以去挂载这个文件夹形式的 rootfs 进而去启动系统。

- 搭建nfs服务器

配置内核以支持nfs作为rootfs，设置nfs启动方式的bootargs，在menuconfig中配置支持nfs启动方式。

- 总结

nfs 方式启动相当于开发板上的内核远程挂载到主机上的 rootfs，nfs 方式启动不用制作 rootfs 镜像。nfs 方式不适合真正的产品，一般作为产品开发阶段调试使用。

#### 1.3.3  关于 linuxrc

- /linuxrc 是一个可执行的应用程序
/linuxrc 是应用层的，和内核源码一点关系都没有，/linuxrc 在开发板当前内核系统下是可执行的。因此在 ARM SoC 的 linux 系统下，这个应用程序就是用 arm-linux-gcc 编译链接的；如果是在 PC 机 linux 系统下，那么这个程序就是用 gcc 编译连接的。

/linuxrc如果是静态编译连接的那么直接可以运行；如果是动态编译连接的那么我们还必须给他提供必要的库文件才能运行。但是因为我们 /linuxrc 这个程序是由内核直接调用执行的，因此用户没有机会去导出库文件的路径，因此实际上这个 /linuxrc 没法动态连接，一般都是静态连接的。

- /linuxrc执行时引出用户界面
操作系统启动后在一系列的自己运行配置之后，最终会给用户一个操作界面（也许是 cmdline，也许是 GUI），这个用户操作界面就是由 /linuxrc 带出来的。

用户界面等很多事并不是在 /linuxrc 程序中负责的，用户界面有自己专门的应用程序，但是用户界面的应用程序是直接或者间接的被 /linuxrc 调用执行的。用户界面程序和其他的应用程序就是进程2、3、4·····，这就是我们说的进程1（init进程，也就是 /linuxrc）是其他所有应用程序进程的祖宗进程。

- /linuxrc 负责系统启动后的配置
就好像一个房子建好之后不能直接住，还要装修一样；操作系统启动起来后也不能直接用，要配置下。操作系统启动后的应用层的配置（一般叫运行时配置，英文简写 etc）是为了让我们的操作系统用起来更方便，更适合我个人的爱好或者实用性。

- /linuxrc在嵌入式linux中一般就是busybox
busybox 是一个 C 语言写出来的项目，里面包含了很多 .c 文件和 .h 文件。这个项目可以被配置编译成各个平台下面可以运行的应用程序。我们如果用 arm-linux-gcc 来编译busybox就会得到一个可以在我们开发板 linux 内核上运行的应用程序。

busybox 这个程序开发出来就是为了在嵌入式环境下构建 rootfs 使用的，也就是说他就是专门开发的 init 进程应用程序。

busybox 为当前系统提供了一整套的 shell 命令程序集。譬如 vi、cd、mkdir、ls 等。在桌面版的linux 发行版（譬如ubuntu、redhat、centOS等）中 vi、cd、ls 等都是一个一个的单独的应用程序。但是在嵌入式 linux 中，为了省事我们把 vi、cd 等所有常用的 shell 命令集合到一起构成了一个shell 命令包，起名叫 busybox。

#### 1.3.4  rootfs 中的其他目录

- /linuxrc

- dev目录下的设备文件
- 
在linux中一切皆是文件，因此一个硬件设备也被虚拟化成一个设备文件来访问，在linux系统中/dev/xxx就表示一个硬件设备，我们要操作这个硬件时就是open打开这个设备文件，然后read/write/ioctl操作这个设备，最后close关闭这个设备。在最小 rootfs 中 /dev 目录也是不可少的，这里面有一两个设备文件是 rootfs 必须的。

- sys和proc目录

在最小 rootfs 中也是不可省略的，但是这两个只要创建了空文件夹即可，里面是没东西的，也不用有东西。这两个目录也是和驱动有关的。属于linux中的虚拟文件系统。

- usr是系统的用户所有的一些文件的存放地，这个东西将来 busybox 安装时会自动生成。

- etc 目录中的所有文件全部都是运行时配置文件。/etc 目录下的所有配置文件会直接或者间接的被 /linuxrc 所调用执行，完成操作系统的运行时配置。etc 目录是制作 rootfs 的关键，所以后面下一个课程专门讲这个 etc 目录。

- lib 目录也是 rootfs 中很关键的一个，不能省略的一个。lib目录下放的是当前操作系统中的动态和静态链接库文件。我们主要是为了其中的动态链接库。